<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Face ID — Add or Know</title>

<!-- Firebase compat (we use compat build to keep code simple) -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<!-- face-api.js -->
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

<style>
  :root{
    --bg:#e9f0f6;
    --card:#ffffff;
    --muted:#6b7280;
    --accent:#0f172a;
    --btn:#fff;
  }
  html, body {
      height: 100%;
      margin: 0;
      font-family: 'Inter', system-ui, sans-serif;
    }

    body {
      background: url('https://images.unsplash.com/photo-1641312874336-6279a832a3dc?q=80&w=652&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D') repeat center/cover;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      overflow: auto;
    }
  .app{
    width:100%;max-width:760px;background:var(--card);border-radius:20px;padding:70px 50px;border-radius:20px;
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    backdrop-filter: blur(14px);
    -webkit-backdrop-filter: blur(14px);
    box-shadow: 0 10px 40px rgba(2,6,23,0.25);
    color: white;
    box-sizing:border-box;
    overflow:auto;
  
  }
  h1{margin:0 0 14px;color:#0b1220;font-size:20px}
  p.lead{color:var(--muted);margin:0 0 22px}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .btn{
    flex:1;min-width:160px;background:linear-gradient(135deg, #92001E, black);color:white;border-radius:14px;padding:14px;text-align:center;border:none;box-shadow:0 6px 18px rgba(2,6,23,0.06);cursor:pointer;font-size:16px;
  }
  .btn.secondary{background:linear-gradient(135deg, #92001E, #black);color:white}
  .status {
  margin-top: 20px;
  color: white; /* corrected syntax */
  font-size: 16px;
  animation: fadeFast 0.3s infinite alternate;
}

@keyframes fadeFast {
  from { opacity: 1; }
  to   { opacity: 0; }
}

  /* modal / camera sheet */
  .sheet{position:fixed;left:0;right:0;bottom:0;top:0;background:rgba(4,6,11,0.45);display:none;align-items:flex-end;justify-content:center;z-index:60}
  .sheet.show{display:flex}
  .panel{width:100%;max-width:720px;background:#fff;border-top-left-radius:18px;border-top-right-radius:18px;padding:12px 16px 26px;box-shadow:0 -8px 40px rgba(2,6,23,0.12)}
  .panel .panel-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .panel .title{font-weight:600}
  .panel .hint{color:var(--muted);font-size:13px}
  #video{width:100%;height:auto;border-radius:12px;background:#111}
  .form{margin-top:12px;display:none}
  input,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid #e6eef8;margin-top:8px;font-size:15px}
  .small{font-size:13px;color:var(--muted);margin-top:10px}
  .badge{display:inline-block;padding:8px 12px;border-radius:12px;background:#f1f5f9;color:#111;margin-top:10px}

  .footer-actions{display:flex;gap:12px;margin-top:12px}
  .btn-ghost{flex:1;background:transparent;border-radius:12px;padding:12px;border:1px solid #e6eef8}
  }
</style>
</head>
<body>
  <div class="app" role="main">
    <h2>Hey Dear</h2>
    <h2>Welcome To</h2>
    <h3>Kundan's AI Face Recognizer </h3>
    <br>
<!-- Copy-paste this block (standalone robot SVG with fixed eyes & blink) -->
<style>
  .robot-svg { width: 180px; height: auto; display:block; margin:20px auto; }
  .robot-svg svg { width:100%; height:auto; display:block; }

  /* small float */
  .robot-body { animation: float 3.6s ease-in-out infinite; transform-origin:center; }
  @keyframes float { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-8px)} }

  /* eye glow */
  .eye-glow { filter: drop-shadow(0 0 10px rgba(20,220,255,0.85)) drop-shadow(0 0 18px rgba(10,150,255,0.45)); }

  /* blink: scaleY to "close" eyes; transform-box ensures correct origin */
  .eye-group { transform-box: fill-box; transform-origin: center; animation: blink 1s infinite; }
  @keyframes blink {
    0%, 92%, 100% { transform: scaleY(1); opacity: 1; }
    94% { transform: scaleY(0.06); opacity: 0.8; }
    95% { transform: scaleY(0.03); opacity: 0.6; }
  }

  /* subtle visor shine (smaller range so it doesn't look like eyebrow) */
  .visor-shine { animation: shine 3.2s linear infinite; opacity:0.45; transform-origin:center; }
  @keyframes shine {
    0% { transform: translateX(-30%); opacity:0; }
    30% { transform: translateX(-8%); opacity:0.18; }
    60% { transform: translateX(8%);  opacity:0.36; }
    100% { transform: translateX(30%); opacity:0; }
  }

  /* shadow under robot */
  .robot-shadow { opacity: 0.32; filter: blur(6px); transition: opacity .3s; }
</style>

<div class="robot-svg" role="img" aria-label="Cute robot with blinking eyes">
<svg viewBox="0 0 480 520" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet">
  <defs>
    <linearGradient id="visorGrad" x1="0" x2="1" y1="0" y2="1">
      <stop offset="0" stop-color="#0b3a94"/>
      <stop offset="0.35" stop-color="#00133a"/>
      <stop offset="1" stop-color="#042359"/>
    </linearGradient>
    <radialGradient id="visorGlow" cx="50%" cy="45%" r="60%">
      <stop offset="0" stop-color="#06e7ff" stop-opacity="0.9"/>
      <stop offset="0.25" stop-color="#00a6ff" stop-opacity="0.22"/>
      <stop offset="1" stop-color="#001540" stop-opacity="0"/>
    </radialGradient>
    <linearGradient id="chestGrad" x1="0" x2="0" y1="0" y2="1">
      <stop offset="0" stop-color="#56d6ff"/>
      <stop offset="1" stop-color="#05a9ff"/>
    </linearGradient>
    <linearGradient id="softWhite" x1="0" x2="1">
      <stop offset="0" stop-color="#fff" stop-opacity="0.95"/>
      <stop offset="1" stop-color="#fff" stop-opacity="0.12"/>
    </linearGradient>
  </defs>

  <!-- shadow -->
  <ellipse cx="240" cy="480" rx="90" ry="18" fill="#0b1220" class="robot-shadow"/>

  <!-- floating robot -->
  <g class="robot-body">
    <!-- body shape -->
    <g transform="translate(60,190)">
      <path d="M120 240 C60 240 40 210 40 160 C40 110 130 85 180 85 C230 85 320 110 320 160 C320 210 300 240 240 240 Z"
            fill="#ffffff" stroke="#0c234a" stroke-width="8" stroke-linejoin="round"/>
      <path d="M120 240 C60 240 40 210 40 160 C40 110 130 85 180 85 C230 85 320 110 320 160 C320 210 300 240 240 240 Z"
            fill="url(#softWhite)" opacity="0.08"/>

      <!-- chest panel -->
      <g transform="translate(120,120)">
        <rect x="-28" y="-6" rx="22" ry="22" width="120" height="86" fill="url(#chestGrad)" stroke="#003b66" stroke-width="6"/>
        <rect x="-18" y="2" rx="16" ry="16" width="100" height="60" fill="rgba(255,255,255,0.12)"/>
      </g>
    </g>

    <!-- head (keeps visor + eyes together so they align) -->
    <g transform="translate(40,30)">
      <!-- head outer -->
      <path d="M200 70 C120 70 86 100 70 150 C64 168 60 190 60 210 C60 260 110 300 200 300 C290 300 340 260 340 210 C340 190 336 168 330 150 C314 100 280 70 200 70 Z"
            fill="#ffffff" stroke="#0c234a" stroke-width="10" stroke-linejoin="round"/>
      <path d="M200 70 C120 70 86 100 70 150 C64 168 60 190 60 210 C60 260 110 300 200 300 C290 300 340 260 340 210 C340 190 336 168 330 150 C314 100 280 70 200 70 Z"
            fill="url(#softWhite)" opacity="0.06"/>

      <!-- visor group - visor + eyes inside it -->
      <g transform="translate(80,120)">
        <ellipse cx="120" cy="40" rx="115" ry="60" fill="url(#visorGrad)"/>
        <ellipse cx="120" cy="40" rx="100" ry="50" fill="url(#visorGlow)" opacity="0.95"/>

        <!-- subtle moving shine on visor (narrow range so it doesn't look like eyebrow) -->
        <path d="M15 20 C60 -5 180 -5 225 20" fill="none" stroke="rgba(255,255,255,0.12)" stroke-width="16" stroke-linecap="round" class="visor-shine"/>

        <!-- EYES: placed relative to visor center - keeps alignment when scaled -->
        <g class="eye-group eye-glow" transform="translate(0,0)">
          <!-- left smile-eye (arc) -->
          <path d="M64 40 Q86 18 108 40" fill="none" stroke="#1ef4ff" stroke-width="10" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M64 40 Q86 18 108 40" fill="none" stroke="#56fbff" stroke-width="4" stroke-linecap="round" opacity="0.35"/>

          <!-- right smile-eye (arc) -->
          <path d="M152 40 Q174 18 196 40" fill="none" stroke="#1ef4ff" stroke-width="10" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M152 40 Q174 18 196 40" fill="none" stroke="#56fbff" stroke-width="4" stroke-linecap="round" opacity="0.35"/>
        </g>
      </g>

      <!-- small ear accents (purely decorative) -->
      <rect x="20" y="160" rx="10" ry="10" width="28" height="40" fill="#ffffff" stroke="#0c234a" stroke-width="6"/>
      <rect x="360" y="160" rx="10" ry="10" width="28" height="40" fill="#ffffff" stroke="#0c234a" stroke-width="6"/>
    </g>
  </g>
</svg>
</div>
    <h4>Tap on Add your Face to Add details</h4>
    <h4>Tap on Know About Your Face to see details</h4>
     <br>
    <div class="row">
      <button id="btnAdd" class="btn">Add Your Face</button>
      <button id="btnKnow" class="btn secondary">Know About Your Face</button>
    </div>
      <br>
    <div class="status" id="status">Loading AI models… (this may take a few seconds on mobile)</div>
  </div>

  <!-- camera sheet -->
  <div class="sheet" id="sheet">
    <div class="panel" role="dialog" aria-modal="true">
      <div class="panel-header">
        <div>
          <div class="title" id="sheetTitle">Looking for a face to capture…</div>
          <div class="hint" id="sheetHint">Move your face into the frame. The app captures a descriptor when face is detected.</div>
        </div>
        <div>
          <button class="btn-ghost" id="closeSheet">Close</button>
        </div>
      </div>

      <video id="video" autoplay muted playsinline></video>

      <div id="resultArea" style="display:none;">
        <div class="badge" id="matchBadge"></div>
        <div class="small" id="matchInfo"></div>
      </div>

      <div class="form" id="addForm">
        <input id="inputName" placeholder="Full name" />
        <textarea id="inputBio" rows="3" placeholder="Short bio / description"></textarea>
        <div class="footer-actions">
          <button class="btn" id="saveBtn">Save Face Details</button>
          <button class="btn-ghost" id="retakeBtn">Retake</button>
        </div>
      </div>

      <div id="knowDetails" style="display:none;margin-top:12px;">
        <div style="font-weight:600" id="knownName"></div>
        <div style="color:var(--muted);margin-top:6px" id="knownBio"></div>
      </div>

    </div>
  </div>

<script>
(async function(){
  // ---------- FIREBASE (compat) ----------
  const firebaseConfig = {
    apiKey: "AIzaSyCgqUo8nanOWML5QhZlg6Ttd4q_GktI9-Q",
    authDomain: "feceid-245b7.firebaseapp.com",
    projectId: "feceid-245b7",
    storageBucket: "feceid-245b7.firebasestorage.app",
    messagingSenderId: "730720795658",
    appId: "1:730720795658:web:0176127b4f0f5987b0f3f3"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // ---------- UI refs ----------
  const statusEl = document.getElementById('status');
  const btnAdd = document.getElementById('btnAdd');
  const btnKnow = document.getElementById('btnKnow');
  const sheet = document.getElementById('sheet');
  const closeSheet = document.getElementById('closeSheet');
  const video = document.getElementById('video');
  const sheetTitle = document.getElementById('sheetTitle');
  const sheetHint = document.getElementById('sheetHint');
  const addForm = document.getElementById('addForm');
  const inputName = document.getElementById('inputName');
  const inputBio = document.getElementById('inputBio');
  const saveBtn = document.getElementById('saveBtn');
  const retakeBtn = document.getElementById('retakeBtn');
  const resultArea = document.getElementById('resultArea');
  const matchBadge = document.getElementById('matchBadge');
  const matchInfo = document.getElementById('matchInfo');
  const knowDetails = document.getElementById('knowDetails');
  const knownName = document.getElementById('knownName');
  const knownBio = document.getElementById('knownBio');

  // ---------- model path (IMPORTANT for GitHub Pages subpath) ----------
  // compute base path (ensures models path works on e.g. https://user.github.io/repo/)
  const basePath = (function(){
    // location.pathname may be '/repo/' or '/repo/index.html'
    let path = location.pathname;
    // if ends with filename, strip it
    path = path.replace(/\/[^\/]*$/, '/');
    return path;
  })();
  const MODELS_URL = basePath + 'models';

  // ---------- load models ----------
  let modelsLoaded = false;
  try {
    statusEl.textContent = 'Loading Kundan AI models… please wait';
    // load required nets
    await Promise.all([
      faceapi.nets.ssdMobilenetv1.loadFromUri(MODELS_URL),
      faceapi.nets.faceLandmark68Net.loadFromUri(MODELS_URL),
      faceapi.nets.faceRecognitionNet.loadFromUri(MODELS_URL)
    ]);
    modelsLoaded = true;
    statusEl.textContent = 'Models loaded. Tap Add Your Face or Know About Your Face.';
  } catch (err) {
    console.error('Model load error:', err);
    alert('Models failed to load — check console & models folder path. (MODELS_URL='+MODELS_URL+')');
    statusEl.textContent = 'Model load failed. Open console for details.';
    return;
  }

  // ---------- runtime state ----------
  let currentAction = null; // 'add' | 'know'
  let stream = null;
  let detectInterval = null;
  let lastDescriptor = null;
  let labeledFaceMatcher = null; // faceapi.FaceMatcher
  let labelDataMap = {}; // label -> { id, name, bio }

  // helpers
  function showSheet(){
    sheet.classList.add('show');
  }
  function hideSheet(){
    sheet.classList.remove('show');
  }

  async function startCamera(){
    // prefer small/medium resolution for performance on mobile
    try{
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } },
        audio: false
      });
      video.srcObject = stream;
      // ensure play / metadata loaded
      await new Promise((resolve) => {
        video.onloadedmetadata = () => {
          video.play().then(resolve).catch(resolve);
        };
      });
    }catch(e){
      console.error('camera error', e);
      alert('Camera permission denied or not available. Please allow camera access and retry.');
      throw e;
    }
  }

  async function stopCamera(){
    if(stream){
      stream.getTracks().forEach(t => t.stop());
      stream = null;
    }
    video.pause();
    video.srcObject = null;
  }

  // load all saved faces from Firestore and create a FaceMatcher
  async function loadSavedFacesToMatcher(){
    labelDataMap = {};
    const snapshot = await db.collection('faces').get();
    const labeledDescriptors = [];
    snapshot.forEach(doc => {
      const data = doc.data();
      // descriptor stored as array (Array<number>)
      if (Array.isArray(data.descriptor) && data.descriptor.length > 0){
        const desc = new Float32Array(data.descriptor);
        labeledDescriptors.push(new faceapi.LabeledFaceDescriptors(data.name, [desc]));
        // store metadata by label (name)
        labelDataMap[data.name] = { id: doc.id, name: data.name, bio: data.bio || '' };
      }
    });
    if(labeledDescriptors.length){
      // threshold 0.5 is okay; 0.6 default is tolerant
      labeledFaceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.5);
    } else {
      labeledFaceMatcher = null;
    }
  }

  // continuously run detection while modal visible
  function startDetectionLoop(){
    // clear existing
    if(detectInterval) clearInterval(detectInterval);
    detectInterval = setInterval(async ()=>{
      if(!video || video.readyState < 2) return; // not ready
      try{
        // use ssdMobilenetv1 with lowered minConfidence for robustness on some phones
        const detection = await faceapi
          .detectSingleFace(video, new faceapi.SsdMobilenetv1Options({ minConfidence: 0.3 }))
          .withFaceLandmarks()
          .withFaceDescriptor();
        if(!detection) {
          sheetTitle.textContent = currentAction === 'add' ? 'Looking for a face to capture…' : 'Scanning for a saved face…';
          return;
        }

        // we have a descriptor
        const descriptor = detection.descriptor;
        if(currentAction === 'add'){
          // if we already found one descriptor and it's similar to previous, ignore
          lastDescriptor = descriptor;
          // stop scanning and show form
          sheetTitle.textContent = 'Face captured ✔ — add details';
          sheetHint.textContent = 'Enter name & bio, then Save Face Details.';
          addForm.style.display = 'block';
          resultArea.style.display = 'none';
          knowDetails.style.display = 'none';
          // pause detection loop so user fills form
          if(detectInterval){ clearInterval(detectInterval); detectInterval = null; }
        } else if (currentAction === 'know'){
          // ensure matcher loaded
          if(!labeledFaceMatcher){
            sheetTitle.textContent = 'No saved faces yet';
            sheetHint.textContent = 'No faces found in database. Try Add Your Face first.';
            return;
          }
          const best = labeledFaceMatcher.findBestMatch(descriptor);
          // best.distance is Euclidean — lower means better (0 perfect). threshold set when creating FaceMatcher.
          if(best.label !== 'unknown'){
            // show matched info
            const meta = labelDataMap[best.label] || { name: best.label, bio: '' };
            sheetTitle.textContent = `Matched: ${meta.name}`;
            sheetHint.textContent = `Confidence: ${(1 - best.distance).toFixed(2)} (lower distance is better)`;
            resultArea.style.display = 'block';
            matchBadge.textContent = meta.name;
            matchInfo.textContent = `Score (distance): ${best.distance.toFixed(3)}`;
            knownName.textContent = meta.name;
            knownBio.textContent = meta.bio || 'No bio provided';
            knowDetails.style.display = 'block';
            // pause scanning to avoid rapid repeated hits
            if(detectInterval){ clearInterval(detectInterval); detectInterval = null; }
          } else {
            sheetTitle.textContent = 'No match — try moving closer';
            sheetHint.textContent = 'Scanning for a saved face…';
            resultArea.style.display = 'none';
            knowDetails.style.display = 'none';
          }
        }
      }catch(err){
        console.error('detect error', err);
      }
    }, 300); // every 300ms
  }

  // ---------- UI actions ----------
  btnAdd.addEventListener('click', async ()=>{
    if(!modelsLoaded) return alert('Still loading models, wait a moment.');
    currentAction = 'add';
    addForm.style.display = 'none';
    resultArea.style.display = 'none';
    knowDetails.style.display = 'none';
    sheetTitle.textContent = 'Looking for a face to capture…';
    sheetHint.textContent = 'Move your face into the frame. The app captures a descriptor when face is detected.';
    showSheet();
    try{
      await startCamera();
      // ensure saved descriptors not interfering
      lastDescriptor = null;
      startDetectionLoop();
    }catch(e){
      hideSheet();
    }
  });

  btnKnow.addEventListener('click', async ()=>{
    if(!modelsLoaded) return alert('Still loading models, wait a moment.');
    currentAction = 'know';
    addForm.style.display = 'none';
    resultArea.style.display = 'none';
    knowDetails.style.display = 'none';
    sheetTitle.textContent = 'Preparing to scan…';
    sheetHint.textContent = 'Loading saved faces from database…';
    showSheet();
    try{
      await loadSavedFacesToMatcher();
      await startCamera();
      // start scanning
  
sheetTitle.textContent = 'Scanning for a saved face…';
      sheetHint.textContent = 'Move a known face into frame.';
      startDetectionLoop();
    }catch(e){
      hideSheet();
    }
  });

  closeSheet.addEventListener('click', async ()=>{
    // stop scanning + camera
    if(detectInterval){ clearInterval(detectInterval); detectInterval = null; }
    await stopCamera();
    addForm.style.display = 'none';
    resultArea.style.display = 'none';
    knowDetails.style.display = 'none';
    // reset messages
    sheetTitle.textContent = '';
    sheetHint.textContent = '';
    hideSheet();
  });

  retakeBtn.addEventListener('click', ()=>{
    // allow scanning again
    addForm.style.display = 'none';
    lastDescriptor = null;
    sheetTitle.textContent = 'Looking for a face to capture…';
    sheetHint.textContent = 'Move your face into the frame.';
    if(!detectInterval) startDetectionLoop();
  });

  saveBtn.addEventListener('click', async ()=>{
    const name = (inputName.value || '').trim();
    const bio = (inputBio.value || '').trim();
    if(!name) return alert('Please enter a name.');
    if(!lastDescriptor) return alert('No face descriptor captured — retake.');
    // store descriptor as plain array of numbers
    const arr = Array.from(lastDescriptor);
    try{
      await db.collection('faces').add({ name, bio, descriptor: arr, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
      alert('Saved successfully!');
      // refresh matcher for future lookups
      await loadSavedFacesToMatcher();
      // close or allow retake
      if(detectInterval){ clearInterval(detectInterval); detectInterval = null; }
      await stopCamera();
      hideSheet();
      inputName.value = '';
      inputBio.value = '';
    }catch(err){
      console.error('save error', err);
      alert('Failed to save — check console.');
    }
  });

  // when page unload, stop camera
  window.addEventListener('beforeunload', async ()=>{ if(stream) stream.getTracks().forEach(t=>t.stop()); });

})();
</script>
</body>
</html>
