<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Face ID — Add / Know</title>

  <!-- Fonts & minimal reset -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Firebase compat libs (browser globals 'firebase') -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

  <!-- TensorFlow and face-api (face-api needs tf) -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.13.0/dist/tf.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

  <style>
    :root{
      --bg1:#c7d2e0;
      --bg2:#f6f8fb;
      --glass: rgba(255,255,255,0.35);
      --accent: linear-gradient(135deg,#3b82f6,#0ea5a5);
      --card-shadow: 0 10px 30px rgba(20,20,30,0.12);
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Inter,Roboto,Helvetica,sans-serif;
    }
    html,body {height:100%; margin:0;}
    body{
      background:linear-gradient(135deg,var(--bg1),var(--bg2));
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
      -webkit-font-smoothing:antialiased;
    }

    .wrap{
      width:100%;
      max-width:720px;
      height:85vh;
      border-radius:22px;
      padding:20px;
      background: linear-gradient(180deg, rgba(255,255,255,0.55), rgba(255,255,255,0.35));
      box-shadow: var(--card-shadow);
      backdrop-filter: blur(14px) saturate(150%);
      border: 1px solid rgba(255,255,255,0.6);
      display:flex;
      flex-direction:column;
      gap:18px;
      box-sizing:border-box;
    }

    header {
      padding:12px 18px;
      border-radius:14px;
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(8px);
      text-align:left;
      color:#0f172a;
      font-weight:700;
      font-size:20px;
      border-bottom:1px solid rgba(255,255,255,0.4);
    }

    .center {
      display:flex;
      flex:1;
      align-items:center;
      justify-content:center;
      position:relative;
    }

    .primary-area{
      width:100%;
      max-width:520px;
      text-align:center;
      padding:28px;
    }

    .desc {
      color: rgba(15,23,42,0.7);
      margin-bottom:24px;
      font-size:15px;
    }

    .btn {
      display:inline-block;
      margin:10px;
      padding:14px 30px;
      border-radius:14px;
      border:none;
      cursor:pointer;
      font-size:17px;
      font-weight:600;
      box-shadow: 0 8px 20px rgba(15,23,42,0.08);
      transition: transform .15s ease, box-shadow .15s ease;
      background: rgba(255,255,255,0.75);
    }
    .btn:hover { transform: translateY(-3px); box-shadow: 0 14px 40px rgba(15,23,42,0.12); }

    .btn-accent {
      background: linear-gradient(90deg,#3b82f6,#06b6d4);
      color:#fff; border: none;
    }

    /* Modal / camera area */
    .modal {
      position: fixed;
      inset:0;
      display:flex;
      justify-content:center;
      align-items:flex-end;
      pointer-events:none;
    }
    .panel {
      width:100%;
      max-width:740px;
      pointer-events:all;
      background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.8));
      backdrop-filter: blur(14px) saturate(130%);
      border-radius:20px 20px 0 0;
      box-shadow: 0 -20px 60px rgba(10,10,20,0.18);
      padding:16px;
      box-sizing:border-box;
      transform: translateY(100%);
      transition: transform .32s cubic-bezier(.2,.9,.32,1);
    }
    .panel.open{ transform: translateY(0); }

    .controls { display:flex; gap:10px; align-items:center; justify-content:space-between; margin-bottom:12px;}
    .status { font-size:13px; color:#123; opacity:.8; }
    video {
      width:100%;
      border-radius:12px;
      background:#000;
      max-height:56vh;
      object-fit:cover;
    }
    .form {
      display:flex;
      gap:10px;
      flex-direction:column;
      margin-top:12px;
    }
    input, textarea {
      padding:10px 12px;
      border-radius:10px;
      border:1px solid rgba(40,40,60,0.08);
      font-size:14px;
      width:100%;
      box-sizing:border-box;
    }
    .small {
      font-size:13px; color:#0f172a; opacity:.8;
    }
    .resultCard {
      margin-top:12px;
      background: rgba(255,255,255,0.6);
      padding:10px;
      border-radius:10px;
      border:1px solid rgba(0,0,0,0.05);
      text-align:left;
    }
    .muted { color:rgba(10,20,30,0.6); font-size:13px; }

    /* mobile friendly */
    @media (max-width:520px){
      .wrap { height:92vh; padding:12px; border-radius:16px; }
      header { font-size:18px; padding:10px; }
      .btn { padding:12px 20px; font-size:15px; border-radius:12px; }
      .panel { border-radius:14px; padding:12px;}
    }
  </style>
</head>
<body>
  <div class="wrap" role="main">
    <header>Face ID — Add your face or Know about you</header>

    <div class="center">
      <div class="primary-area">
        <p class="desc">Tap <strong>Add Your Face</strong> to register (camera will open, it captures your face descriptor, then you can save name & bio). Tap <strong>Know About Your Face</strong> to scan and show saved info if it matches a stored face.</p>

        <div>
          <button id="btnAdd" class="btn btn-accent">Add Your Face</button>
          <button id="btnKnow" class="btn">Know About Your Face</button>
        </div>

        <div style="margin-top:22px;">
          <div id="globalStatus" class="muted small">Tip: Allow camera when prompted. Models will load on page open — please wait for "ready".</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Camera / panel that slides up -->
  <div class="modal" aria-hidden="true">
    <div id="panel" class="panel" role="dialog" aria-modal="true" aria-label="Camera panel">
      <div class="controls">
        <div class="status" id="statusText">Initializing…</div>
        <div>
          <button id="btnClose" class="btn">Close</button>
        </div>
      </div>

      <video id="video" autoplay muted playsinline></video>

      <div id="below" class="form" style="display:none;">
        <!-- Add flow form -->
        <div id="addForm" style="display:none;">
          <input id="name" placeholder="Enter name (for storage)">
          <textarea id="bio" rows="3" placeholder="Enter bio / notes"></textarea>
          <div style="display:flex;gap:8px;justify-content:flex-end;">
            <button id="btnSave" class="btn btn-accent">Save Face Details</button>
          </div>
        </div>

        <!-- Know flow results -->
        <div id="knowResult" style="display:none;">
          <div class="resultCard" id="resultCard">No match yet</div>
        </div>

        <div class="small muted" id="captureHint" style="display:none;">Move your face into the frame. The app captures a descriptor when face is detected.</div>
      </div>
    </div>
  </div>

  <script>
  (function(){
    // --------- FIREBASE CONFIG (your provided keys) ----------
    const firebaseConfig = {
      apiKey: "AIzaSyCgqUo8nanOWML5QhZlg6Ttd4q_GktI9-Q",
      authDomain: "feceid-245b7.firebaseapp.com",
      projectId: "feceid-245b7",
      storageBucket: "feceid-245b7.firebasestorage.app",
      messagingSenderId: "730720795658",
      appId: "1:730720795658:web:0176127b4f0f5987b0f3f3"
    };
    // Initialize firebase (compat)
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // --------- UI elements ----------
    const btnAdd = document.getElementById('btnAdd');
    const btnKnow = document.getElementById('btnKnow');
    const btnClose = document.getElementById('btnClose');
    const btnSave = document.getElementById('btnSave');

    const panel = document.getElementById('panel');
    const modal = document.querySelector('.modal');
    const video = document.getElementById('video');
    const statusText = document.getElementById('statusText');
    const below = document.getElementById('below');
    const addForm = document.getElementById('addForm');
    const knowResult = document.getElementById('knowResult');
    const resultCard = document.getElementById('resultCard');
    const captureHint = document.getElementById('captureHint');

    const nameInput = document.getElementById('name');
    const bioInput = document.getElementById('bio');
    const globalStatus = document.getElementById('globalStatus');

    // --------- Variables ----------
    let currentAction = null; // 'add' or 'know'
    let stream = null;
    let detectInterval = null;
    let labeledFaceDescriptors = []; // face-api LabeledFaceDescriptors
    let faceMatcher = null;
    let latestDescriptor = null; // Float32Array as plain array for storing
    let modelsLoaded = false;

    // relative path to models folder (must be correct for GitHub Pages) --- IMPORTANT
    const MODELS_PATH = 'models'; // relative path (not '/models')

    // ---- helpers for UI ----
    function openPanel(){
      modal.style.display = 'flex';
      setTimeout(()=> panel.classList.add('open'), 20);
      below.style.display = 'block';
    }
    function closePanel(){
      panel.classList.remove('open');
      setTimeout(()=> { modal.style.display='none'; below.style.display='none'; }, 280);
      stopDetection();
      stopCamera();
      resetUI();
      currentAction = null;
    }
    function setStatus(t){ statusText.textContent = t; console.log('[STATUS]', t); }
    function setGlobalStatus(t){ globalStatus.textContent = t; }

    function resetUI(){
      addForm.style.display = 'none';
      knowResult.style.display = 'none';
      resultCard.innerHTML = 'No match yet';
      captureHint.style.display = 'none';
      nameInput.value = ''; bioInput.value = '';
      latestDescriptor = null;
    }

    // ---- start/stop camera ----
    async function startCamera(){
      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
        video.srcObject = stream;
        await video.play();
        return true;
      } catch(err) {
        console.error('Camera error', err);
        alert('Camera access denied or not available. Please allow camera permission.');
        return false;
      }
    }
    function stopCamera(){
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      try { video.pause(); video.srcObject = null; } catch(e){}
    }

    // ---- detection loop ----
    async function startDetectionLoop(){
      stopDetection();
      detectInterval = setInterval(async () => {
        if (!video || video.readyState < 2) return;
        try {
          const detection = await faceapi.detectSingleFace(video, new faceapi.SsdMobilenetv1Options({ minConfidence: 0.5 })).withFaceLandmarks().withFaceDescriptor();
          if (detection && detection.descriptor) {
            // We have a face descriptor
            if (currentAction === 'add') {
              // show form and capture descriptor for save
              if (!latestDescriptor) {
                // capture descriptor once
                latestDescriptor = Array.from(detection.descriptor);
                addForm.style.display = 'block';
                captureHint.style.display = 'none';
                setStatus('Face captured — fill name & bio and press Save.');
                // show a small preview text
              }
            } else if (currentAction === 'know') {
              if (labeledFaceDescriptors.length === 0) {
                setStatus('No saved faces to match — none found in database.');
                return;
              }
              // create/maybe update matcher
              if (!faceMatcher) faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors, 0.55);
              const best = faceMatcher.findBestMatch(detection.descriptor);
              console.log('best match', best);
              if (best && best.label && best.label !== 'unknown') {
                // fetch details from db (by name)
                setStatus(`Matched: ${best.label} (distance ${best.distance.toFixed(3)})`);
                const snapshot = await db.collection('faces').where('name', '==', best.label).limit(1).get();
                if (!snapshot.empty) {
                  const data = snapshot.docs[0].data();
                  resultCard.innerHTML = `<strong>Name:</strong> ${data.name}<br><strong>Bio:</strong> ${data.bio || ''}<br><small class="muted">distance: ${best.distance.toFixed(3)}</small>`;
                  knowResult.style.display = 'block';
                } else {
                  resultCard.innerHTML = `Matched '${best.label}' but no record found (db).`;
                }
                // Optionally stop detection for a few seconds
                // stopDetection();
              } else {
                setStatus('Face detected — no matching saved face found.');
                resultCard.innerHTML = 'No matching saved face found.';
                knowResult.style.display = 'block';
              }
            }
          } else {
            // nothing detected
            // show capture hint in add mode
            if (currentAction === 'add' && !latestDescriptor) {
              captureHint.style.display = 'block';
              setStatus('Looking for a face... (please center your face)');
            } else if (currentAction === 'know') {
              setStatus('Looking for a face to match...');
            }
          }
        } catch(err){
          console.error('Detection error', err);
        }
      }, 700); // every 700ms
    }
    function stopDetection(){
      if (detectInterval) { clearInterval(detectInterval); detectInterval = null; }
    }

    // ---- load saved faces from Firestore ----
    async function loadSavedFaces(){
      try {
        setStatus('Loading saved faces from database...');
        const snapshot = await db.collection('faces').get();
        labeledFaceDescriptors = [];
        snapshot.docs.forEach(doc => {
          const d = doc.data();
          if (d && d.descriptor && d.descriptor.length) {
            // convert array -> Float32Array for face-api
            const fd = new Float32Array(d.descriptor);
            labeledFaceDescriptors.push(new faceapi.LabeledFaceDescriptors(d.name, [fd]));
          } else {
            console.warn('Invalid descriptor for doc', doc.id);
          }
        });
        console.log('Loaded labeledFaceDescriptors:', labeledFaceDescriptors.length);
        if (labeledFaceDescriptors.length === 0) setStatus('No saved faces found in DB.');
        else setStatus(`Loaded ${labeledFaceDescriptors.length} saved face(s).`);
        // recreate matcher
        faceMatcher = labeledFaceDescriptors.length ? new faceapi.FaceMatcher(labeledFaceDescriptors, 0.55) : null;
      } catch(err){
        console.error('Error loading saved faces', err);
        setStatus('Failed to load saved faces (check console).');
      }
    }

    // ---- save face record to Firestore ----
    async function saveFaceRecord(){
      const name = nameInput.value.trim();
      const bio = bioInput.value.trim();
      if (!name) return alert('Please enter a name.');
      if (!latestDescriptor) return alert('No captured face descriptor found yet. Move your face into the frame until it captures.');
      try {
        setStatus('Saving face to database...');
        await db.collection('faces').add({
          name,
          bio,
          descriptor: latestDescriptor,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        // update local descriptors so Know can match right away
        labeledFaceDescriptors.push(new faceapi.LabeledFaceDescriptors(name, [ new Float32Array(latestDescriptor) ]));
        faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors, 0.55);
        setStatus('Saved! You can now use "Know About Your Face" to retrieve this record.');
        alert('Face saved successfully!');
        closePanel();
      } catch(err){
        console.error('Save error', err);
        alert('Failed to save to database — check console.');
        setStatus('Save failed (see console).');
      }
    }

    // ---- model loading ----
    async function loadModels(){
      try {
        setGlobalStatus('Loading AI models — please wait...');
        setStatus('Downloading AI models (this can take a few seconds)...');
        // Important: use relative path 'models' (not '/models') so GitHub Pages resolves correctly for repo pages
        await faceapi.nets.ssdMobilenetv1.loadFromUri(MODELS_PATH);
        await faceapi.nets.faceLandmark68Net.loadFromUri(MODELS_PATH);
        await faceapi.nets.faceRecognitionNet.loadFromUri(MODELS_PATH);
        modelsLoaded = true;
        setStatus('Models loaded and ready.');
        setGlobalStatus('Ready — models loaded. Tap a button to start.');
        console.log('models loaded from', MODELS_PATH);
      } catch(err){
        console.error('Model load failed:', err);
        alert('Models failed to load — check console & models folder path. Make sure models/ is uploaded and accessible.');
        setStatus('Model load failed. Check console & model files path.');
        setGlobalStatus('Model load failed — see console.');
        modelsLoaded = false;
      }
    }

    // ---- Wiring UI ----
    btnAdd.addEventListener('click', async () => {
      if (!modelsLoaded) {
        alert('Please wait — models are still loading (or failed). See page status.');
        return;
      }
      currentAction = 'add';
      resetUI();
      openPanel();
      addForm.style.display = 'none';
      knowResult.style.display = 'none';
      captureHint.style.display = 'block';
      setStatus('Opening camera...');
      const ok = await startCamera();
      if (!ok) { closePanel(); return; }
      // start detection loop for add
      setStatus('Looking for a face to capture...');
      startDetectionLoop();
    });

    btnKnow.addEventListener('click', async () => {
      if (!modelsLoaded) {
        alert('Please wait — models are still loading (or failed). See page status.');
        return;
      }
      currentAction = 'know';
      resetUI();
      openPanel();
      captureHint.style.display = 'none';
      setStatus('Opening camera...');
      const ok = await startCamera();
      if (!ok) { closePanel(); return; }
      // load saved faces first
      await loadSavedFaces();
      setStatus('Looking for a face to match...');
      startDetectionLoop();
    });

    btnClose.addEventListener('click', () => closePanel());
    btnSave.addEventListener('click', () => saveFaceRecord());

    // load models at startup
    window.addEventListener('load', () => {
      // ensure face-api script finished loading
      if (!faceapi || !faceapi.nets) {
        alert('face-api library failed to load. Check network.');
        return;
      }
      loadModels();
    });

    // cleanup when tab closes
    window.addEventListener('beforeunload', () => {
      stopDetection();
      stopCamera();
    });
  })();
  </script>
</body>
</html>
